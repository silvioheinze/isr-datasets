{% extends "_base.html" %}
{% load i18n %}

{% block title %}{% trans "Dashboard" %} - {% trans "ISR Datasets" %}{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- Welcome Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="text-center">
                <h1 class="display-4 fw-bold text-primary mb-3">
                    <i class="bi bi-database-fill me-3"></i>
                    {% trans "Welcome to ISR Datasets" %}
                </h1>
                <p class="lead text-muted">
                    {% trans "A comprehensive platform for managing, accessing, and analyzing research datasets" %}
                </p>
            </div>
        </div>
    </div>

    <!-- Quick Stats Cards -->
    <div class="row mb-5">
        <div class="col-md-3 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-collection fs-1 mb-3 text-primary"></i>
                    <h3 class="card-title">{{ total_datasets|default:0 }}</h3>
                    <p class="card-text">{% trans "Published Datasets" %}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-download fs-1 mb-3 text-success"></i>
                    <h3 class="card-title">{{ data_volume_display|default:"0KB" }}</h3>
                    <p class="card-text">{% trans "Data Volume" %}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-people fs-1 mb-3 text-info"></i>
                    <h3 class="card-title">{{ total_users|default:0 }}</h3>
                    <p class="card-text">{% trans "Active Users" %}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-folder fs-1 mb-3 text-warning"></i>
                    <h3 class="card-title">{{ total_projects|default:0 }}</h3>
                    <p class="card-text">{% trans "Active Projects" %}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Section (shown only for 7 days after first login) -->
    {% if show_help_section %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="text-center">
                <div class="alert alert-info border-0 shadow-sm">
                    <div class="d-flex align-items-center justify-content-center">
                        <i class="bi bi-question-circle-fill me-3 fs-4"></i>
                        <div>
                            <strong>{% trans "Need help getting started?" %}</strong>
                            <p class="mb-0">{% trans "Check out our comprehensive documentation for guides and tutorials." %}</p>
                        </div>
                        <a href="{% url 'documentation' %}" class="btn btn-outline-primary ms-3">
                            <i class="bi bi-book me-2"></i>
                            {% trans "View Documentation" %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Announcements Section -->
    {% if active_announcements %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">
                    <i class="bi bi-megaphone me-2"></i>
                    {% trans "Announcements" %}
                </h4>
                {% if user.is_superuser or user.has_role_permission|default:False %}
                <a href="{% url 'announcement-management' %}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-gear me-1"></i>
                    {% trans "Manage Announcements" %}
                </a>
                {% endif %}
            </div>
            {% for announcement in active_announcements %}
            <div class="alert alert-{{ announcement.get_priority_class }} border-0 shadow-sm mb-3">
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0 me-3">
                        {% if announcement.priority == 'urgent' %}
                            <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                        {% elif announcement.priority == 'high' %}
                            <i class="bi bi-exclamation-circle-fill fs-4"></i>
                        {% elif announcement.priority == 'normal' %}
                            <i class="bi bi-info-circle-fill fs-4"></i>
                        {% else %}
                            <i class="bi bi-info-circle fs-4"></i>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="alert-heading mb-2">
                            {{ announcement.title }}
                            {% if announcement.priority == 'urgent' %}
                                <span class="badge bg-danger ms-2">{% trans "URGENT" %}</span>
                            {% elif announcement.priority == 'high' %}
                                <span class="badge bg-warning ms-2">{% trans "HIGH" %}</span>
                            {% endif %}
                        </h5>
                        <p class="mb-2">{{ announcement.message|linebreaks }}</p>
                        <small class="text-muted">
                            <i class="bi bi-person me-1"></i>
                            {% trans "Posted by" %} {{ announcement.created_by.get_full_name|default:announcement.created_by.username }}
                            <i class="bi bi-calendar me-1 ms-2"></i>
                            {{ announcement.created_at|date:"M d, Y" }}
                            {% if announcement.valid_until %}
                                <i class="bi bi-clock me-1 ms-2"></i>
                                {% trans "Valid until" %} {{ announcement.valid_until|date:"M d, Y" }}
                            {% endif %}
                        </small>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Recent Activity & Popular Datasets -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        {% trans "Recent Activity" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if recent_versions %}
                        <div class="list-group list-group-flush">
                            {% for version in recent_versions %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-{% if version.dataset.status == 'published' %}upload{% else %}pencil{% endif %} {% if version.dataset.status == 'published' %}text-success{% else %}text-warning{% endif %} me-2"></i>
                                    <strong>
                                        {% if version.dataset.status == 'published' %}
                                            {% trans "New version added" %}
                                        {% else %}
                                            {% trans "Version updated" %}
                                        {% endif %}
                                    </strong>
                                    <br>
                                    <small class="text-muted">
                                        <a href="{% url 'datasets:dataset_detail' version.dataset.pk %}" class="text-decoration-none">
                                            {{ version.dataset.title }}
                                        </a> • {{ version.created_at|timesince }} {% trans "ago" %}
                                    </small>
                                </div>
                                <span class="badge {% if version.dataset.status == 'published' %}bg-success{% else %}bg-warning{% endif %}">
                                    {% if version.dataset.status == 'published' %}{% trans "Published" %}{% else %}{% trans "Draft" %}{% endif %}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-clock-history fs-1 text-muted mb-3"></i>
                            <p class="text-muted">{% trans "No recent activity found" %}</p>
                            <a href="{% url 'datasets:dataset_create' %}" class="btn btn-primary btn-sm">
                                <i class="bi bi-plus-circle me-2"></i>
                                {% trans "Add First Dataset" %}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-star me-2"></i>
                        {% trans "Popular Datasets" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if popular_datasets %}
                        <div class="list-group list-group-flush">
                            {% for dataset in popular_datasets %}
                            <a href="{% url 'datasets:dataset_detail' dataset.pk %}" class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ dataset.title }}</h6>
                                    <small class="text-muted">{{ dataset.download_count }} {% trans "downloads" %}</small>
                                </div>
                                <p class="mb-1">{{ dataset.description|truncatechars:60 }}</p>
                                <small class="text-muted">
                                    {% trans "by" %} {% if dataset.publisher %}{{ dataset.publisher.name }}{% else %}{{ dataset.owner.username }}{% endif %} • {{ dataset.updated_at|timesince }} {% trans "ago" %}
                                </small>
                            </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-star fs-1 text-muted mb-3"></i>
                            <p class="text-muted">{% trans "No datasets available yet" %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Categories Overview & User's Datasets -->
    {% if categories_with_counts or user_datasets %}
    <div class="row mt-4">
        {% if categories_with_counts %}
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-tags me-2"></i>
                        {% trans "Dataset Categories" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for category in categories_with_counts %}
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <span class="badge me-2" style="background-color: {{ category.color }}; color: {% if category.color == '#ffffff' or category.color == '#fff' %}#000{% else %}#fff{% endif %};">
                                    {{ category.name }}
                                </span>
                                <small class="text-muted">{{ category.dataset_count }} {% trans "datasets" %}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="text-center mt-3">
                        <a href="{% url 'datasets:category_list' %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-tags me-2"></i>
                            {% trans "View All Categories" %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if user_datasets %}
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-person-circle me-2"></i>
                        {% trans "Your Datasets" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for dataset in user_datasets %}
                        <a href="{% url 'datasets:dataset_detail' dataset.pk %}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ dataset.title }}</h6>
                                <span class="badge {% if dataset.status == 'published' %}bg-success{% elif dataset.status == 'draft' %}bg-warning{% else %}bg-secondary{% endif %}">
                                    {{ dataset.get_status_display }}
                                </span>
                            </div>
                            <p class="mb-1">{{ dataset.description|truncatechars:50 }}</p>
                            <small class="text-muted">
                                {{ dataset.versions.count }} {% trans "versions" %} • {{ dataset.updated_at|timesince }} {% trans "ago" %}
                            </small>
                        </a>
                        {% endfor %}
                    </div>
                    <div class="text-center mt-3">
                        <a href="{% url 'datasets:dataset_create' %}" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-plus-circle me-2"></i>
                            {% trans "Add New Dataset" %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}
