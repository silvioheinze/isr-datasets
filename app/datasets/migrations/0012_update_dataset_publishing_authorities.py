# Generated by Django 5.2.6 on 2025-09-16 13:32

from django.db import migrations, models


def update_dataset_publishing_authorities(apps, schema_editor):
    """Update datasets to reference PublishingAuthority objects"""
    PublishingAuthority = apps.get_model('datasets', 'PublishingAuthority')
    Dataset = apps.get_model('datasets', 'Dataset')
    
    # Create a mapping of authority names to IDs
    authority_map = {}
    for authority in PublishingAuthority.objects.all():
        authority_map[authority.name] = authority.id
    
    # Update datasets with publishing authority references
    for dataset in Dataset.objects.all():
        if dataset.publishing_authority and dataset.publishing_authority.strip():
            authority_name = dataset.publishing_authority.strip()
            if authority_name in authority_map:
                # Store the authority ID in a temporary field
                dataset.publishing_authority_id = authority_map[authority_name]
                dataset.save(update_fields=['publishing_authority_id'])


def reverse_update_dataset_publishing_authorities(apps, schema_editor):
    """Reverse the update - clear the temporary field"""
    Dataset = apps.get_model('datasets', 'Dataset')
    Dataset.objects.all().update(publishing_authority_id=None)


class Migration(migrations.Migration):

    dependencies = [
        ('datasets', '0011_populate_publishing_authorities'),
    ]

    operations = [
        # Add temporary field to store authority ID
        migrations.AddField(
            model_name='dataset',
            name='publishing_authority_id',
            field=models.IntegerField(null=True, blank=True),
        ),
        # Populate the temporary field
        migrations.RunPython(
            update_dataset_publishing_authorities,
            reverse_update_dataset_publishing_authorities
        ),
    ]
